{% extends "base.html" %}

{% block title %}Scam Honeypot Dashboard{% endblock %}

{% block extra_css %}
<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
        color: #eee;
        min-height: 100vh;
        padding: 20px;
    }

    .container {
        max-width: 1400px;
        margin: 0 auto;
    }

    /* Header */
    .header {
        text-align: center;
        margin-bottom: 40px;
        padding: 30px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 20px;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .header h1 {
        font-size: 3em;
        background: linear-gradient(45deg, #00ff88, #00d4ff);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-bottom: 10px;
    }

    .header p {
        color: #aaa;
        font-size: 1.2em;
    }

    /* Stats Cards */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 40px;
    }

    .stat-card {
        background: rgba(255, 255, 255, 0.05);
        padding: 25px;
        border-radius: 15px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        transition: transform 0.3s, box-shadow 0.3s;
    }

    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 30px rgba(0, 255, 136, 0.3);
    }

    .stat-card h3 {
        color: #00ff88;
        font-size: 2.5em;
        margin-bottom: 10px;
    }

    .stat-card p {
        color: #aaa;
        font-size: 1em;
    }

    /* Test Area */
    .test-area {
        background: rgba(255, 255, 255, 0.05);
        padding: 30px;
        border-radius: 20px;
        margin-bottom: 30px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
    }

    .test-area h2 {
        color: #00ff88;
        margin-bottom: 20px;
        font-size: 1.8em;
    }

    textarea {
        width: 100%;
        height: 120px;
        padding: 15px;
        background: rgba(0, 0, 0, 0.3);
        border: 2px solid #00ff88;
        color: #eee;
        border-radius: 10px;
        font-size: 16px;
        font-family: inherit;
        margin-bottom: 15px;
        resize: vertical;
        transition: border-color 0.3s;
    }

    textarea:focus {
        outline: none;
        border-color: #00d4ff;
        box-shadow: 0 0 20px rgba(0, 255, 136, 0.3);
    }

    textarea::placeholder {
        color: #666;
    }

    /* Buttons */
    .button-group {
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
    }

    button {
        background: linear-gradient(45deg, #00ff88, #00d4ff);
        color: #0f0c29;
        border: none;
        padding: 15px 35px;
        border-radius: 10px;
        cursor: pointer;
        font-weight: bold;
        font-size: 16px;
        transition: transform 0.2s, box-shadow 0.2s;
    }

    button:hover {
        transform: scale(1.05);
        box-shadow: 0 5px 20px rgba(0, 255, 136, 0.5);
    }

    button:active {
        transform: scale(0.95);
    }

    button:disabled {
        background: #555;
        cursor: not-allowed;
        opacity: 0.5;
    }

    .btn-secondary {
        background: rgba(255, 255, 255, 0.1);
        color: #eee;
    }

    .btn-danger {
        background: linear-gradient(45deg, #ff4757, #ff6b81);
        color: white;
    }

    /* Sample Messages */
    .samples {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
    }

    .sample-card {
        background: rgba(0, 0, 0, 0.3);
        padding: 15px;
        border-radius: 10px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        cursor: pointer;
        transition: all 0.3s;
    }

    .sample-card:hover {
        border-color: #00ff88;
        background: rgba(0, 255, 136, 0.1);
    }

    .sample-card h4 {
        color: #00ff88;
        margin-bottom: 8px;
        font-size: 0.9em;
    }

    .sample-card p {
        color: #aaa;
        font-size: 0.85em;
        line-height: 1.4;
    }

    /* Results Area */
    .results {
        background: rgba(255, 255, 255, 0.05);
        padding: 30px;
        border-radius: 20px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        min-height: 200px;
    }

    .loading {
        text-align: center;
        padding: 40px;
        color: #00ff88;
        font-size: 1.2em;
    }

    .spinner {
        display: inline-block;
        width: 40px;
        height: 40px;
        border: 4px solid rgba(0, 255, 136, 0.3);
        border-top-color: #00ff88;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    /* Conversation Box */
    .conversation-box {
        background: rgba(0, 0, 0, 0.3);
        padding: 25px;
        border-radius: 15px;
        margin-bottom: 20px;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .detection-badges {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }

    .badge {
        display: inline-block;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 14px;
        font-weight: bold;
    }

    .badge-success {
        background: linear-gradient(45deg, #00ff88, #00d4ff);
        color: #0f0c29;
    }

    .badge-info {
        background: linear-gradient(45deg, #00d4ff, #0984e3);
        color: white;
    }

    /* Messages */
    .message {
        padding: 15px 20px;
        margin: 15px 0;
        border-radius: 12px;
        animation: slideIn 0.3s ease-out;
    }

    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .message-scammer {
        background: linear-gradient(135deg, #ff4757, #ff6b81);
        color: white;
        border-left: 4px solid #ff1744;
    }

    .message-agent {
        background: linear-gradient(135deg, #00ff88, #00d4ff);
        color: #0f0c29;
        border-left: 4px solid #00ff88;
    }

    .message strong {
        display: block;
        margin-bottom: 8px;
        font-size: 0.9em;
        opacity: 0.9;
    }

    .conversation-meta {
        margin-top: 20px;
        padding-top: 20px;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
        color: #aaa;
        font-size: 0.9em;
    }

    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #666;
    }

    .empty-state h3 {
        font-size: 1.5em;
        margin-bottom: 10px;
    }

    /* Responsive */
    @media (max-width: 768px) {
        .header h1 {
            font-size: 2em;
        }

        .stats-grid {
            grid-template-columns: 1fr;
        }

        .button-group {
            flex-direction: column;
        }

        button {
            width: 100%;
        }
    }

    /* Animations */
    .fade-in {
        animation: fadeIn 0.5s ease-in;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
        }
        to {
            opacity: 1;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <!-- Header -->
    <div class="header">
        <h1>üçØ Scam Honeypot</h1>
        <p>AI-Powered Scam Detection & Intelligence Extraction</p>
    </div>

    <!-- Statistics -->
    <div class="stats-grid" id="stats">
        <div class="stat-card">
            <h3 id="totalMessages">0</h3>
            <p>Messages Processed</p>
        </div>
        <div class="stat-card">
            <h3 id="totalConvs">0</h3>
            <p>Conversations</p>
        </div>
        <div class="stat-card">
            <h3 id="activeConvs">0</h3>
            <p>Active Session</p>
        </div>
        <div class="stat-card">
            <h3 id="successRate">100%</h3>
            <p>Response Rate</p>
        </div>
    </div>

    <!-- Test Area -->
    <div class="test-area">
        <h2>üîç Test Scam Detection</h2>
        
        <!-- Sample Messages -->
        <div class="samples">
            <div class="sample-card" onclick="loadSample(0)">
                <h4>üí∞ Lottery Scam</h4>
                <p>Congratulations! You won Rs 10 lakhs in lottery. Send bank details to claim prize...</p>
            </div>
            <div class="sample-card" onclick="loadSample(1)">
                <h4>üè¶ Banking Fraud</h4>
                <p>Your SBI account will be blocked! Update KYC immediately by clicking this link...</p>
            </div>
            <div class="sample-card" onclick="loadSample(2)">
                <h4>üíª Tech Support</h4>
                <p>Your computer has virus! Call Microsoft support urgently at 9876543210...</p>
            </div>
            <div class="sample-card" onclick="loadSample(3)">
                <h4>üì± UPI Scam</h4>
                <p>Pay Rs 500 to verify your account. Send to scammer@paytm now or account suspended...</p>
            </div>
        </div>

        <textarea id="scamMessage" placeholder="Paste a scam message here to test the honeypot system...

Try the sample messages above or paste your own!">Your bank account will be blocked today. Verify immediately.</textarea>
        
        <div class="button-group">
            <button onclick="testScam()" id="detectBtn">
                üîç Send Message
            </button>
            <button onclick="clearResults()" class="btn-danger">
                üóëÔ∏è Clear
            </button>
        </div>
    </div>

    <!-- Results -->
    <div class="results" id="results">
        <div class="empty-state">
            <h3>Ready to test!</h3>
            <p>Paste a message above and click "Send Message" to start</p>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Sample scam messages
    const sampleMessages = [
        "Congratulations! You have won Rs 10,00,000 in lottery draw. Please share your bank account number and IFSC code to claim your prize. Contact us immediately at 9876543210 or send payment to winner@paytm!",
        "Dear SBI Customer, Your account will be blocked due to pending KYC update. Click here immediately: fake-sbi-kyc.com/update or call 9988776655. Urgent action required within 24 hours!",
        "ALERT! Your Windows computer has been infected with dangerous virus. Call Microsoft Technical Support NOW at +91-9876543210. Do not turn off your computer. Visit: fix-windows-virus.com",
        "Your Paytm account needs verification. Pay Rs 500 processing fee to scammerUPI@paytm to unlock your account. Failure to verify will result in permanent suspension. Act now!"
    ];

    let sessionId = generateSessionId();
    let conversationHistory = [];
    let stats = {
        totalMessages: 0,
        totalConvs: 0,
        activeConvs: 0
    };

    // Generate session ID
    function generateSessionId() {
        return 'session_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now();
    }

    // Helper function to make API calls
    async function apiCall(endpoint, data) {
        const response = await fetch(`${window.API_CONFIG.BASE_URL}/api/${endpoint}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-API-Key': window.API_CONFIG.API_KEY
            },
            body: JSON.stringify(data)
        });
        
        if (!response.ok) {
            const error = await response.json().catch(() => ({ message: 'Network error' }));
            throw new Error(error.message || 'API request failed');
        }
        
        return response.json();
    }

    // Load sample message
    function loadSample(index) {
        document.getElementById('scamMessage').value = sampleMessages[index];
    }

    // Test scam detection
    async function testScam() {
        const message = document.getElementById('scamMessage').value.trim();
        const resultsDiv = document.getElementById('results');
        const detectBtn = document.getElementById('detectBtn');

        if (!message) {
            alert('Please enter a message to test!');
            return;
        }

        // Show loading
        detectBtn.disabled = true;
        detectBtn.textContent = 'üîÑ Sending...';
        resultsDiv.innerHTML = '<div class="loading"><div class="spinner"></div><p>Processing message...</p></div>';

        try {
            // ‚úÖ FIXED: Sending in hackathon format
            const data = await apiCall('process-message', {
                sessionId: sessionId,
                message: {
                    sender: "scammer",
                    text: message,
                    timestamp: Date.now()
                },
                conversationHistory: conversationHistory,
                metadata: {
                    channel: "SMS",
                    language: "English",
                    locale: "IN"
                }
            });

            // ‚úÖ FIXED: Only expecting status and reply
            if (!data.reply) {
                throw new Error('Invalid response from server');
            }

            // Store conversation
            conversationHistory.push({
                scammer: message,
                agent: data.reply
            });

            // Display results
            displayResults(data, message);

            // Update stats
            stats.totalMessages++;
            stats.totalConvs = 1;
            stats.activeConvs = 1;
            updateStats();

        } catch (error) {
            resultsDiv.innerHTML = `
                <div class="conversation-box">
                    <div class="message message-scammer">
                        <strong>‚ùå Error</strong>
                        <p>${error.message}</p>
                        <small>Check if the backend server is awake at Render.com</small>
                    </div>
                </div>
            `;
        } finally {
            detectBtn.disabled = false;
            detectBtn.textContent = 'üîç Send Message';
        }
    }

    // ‚úÖ FIXED: Simplified display function
    function displayResults(data, scammerMessage) {
        const resultsDiv = document.getElementById('results');
        
        const conversationHtml = conversationHistory.map((turn, index) => `
            <div class="message message-scammer">
                <strong>üé£ Scammer (Turn ${index + 1}):</strong>
                ${turn.scammer}
            </div>
            <div class="message message-agent">
                <strong>ü§ñ AI Agent (Ramesh):</strong>
                ${turn.agent}
            </div>
        `).join('');

        resultsDiv.innerHTML = `
            <div class="conversation-box fade-in">
                <div class="detection-badges">
                    <span class="badge badge-success">
                        ‚úÖ Response Generated
                    </span>
                    <span class="badge badge-info">
                        Turn: ${conversationHistory.length}
                    </span>
                </div>

                ${conversationHtml}

                <div class="conversation-meta">
                    <p>üí¨ Conversation turns: <strong>${conversationHistory.length}</strong></p>
                    <p>üÜî Session ID: <code>${sessionId}</code></p>
                    <p>üìä Status: <code>${data.status}</code></p>
                </div>
            </div>
        `;
    }

    function updateStats() {
        document.getElementById('totalMessages').textContent = stats.totalMessages;
        document.getElementById('totalConvs').textContent = stats.totalConvs;
        document.getElementById('activeConvs').textContent = stats.activeConvs;
    }

    function clearResults() {
        if (confirm('Clear current conversation?')) {
            sessionId = generateSessionId();
            conversationHistory = [];
            stats = { totalMessages: 0, totalConvs: 0, activeConvs: 0 };
            updateStats();
            
            document.getElementById('results').innerHTML = `
                <div class="empty-state">
                    <h3>Ready to test!</h3>
                    <p>Paste a message above and click "Send Message" to start</p>
                </div>
            `;
            document.getElementById('scamMessage').value = '';
        }
    }

    // Initialize
    updateStats();
</script>
{% endblock %}
